# Организация создания, копирования и удаления слепков данных для моделирования по принципу "что-если".
## Описание задачи и цели.
Достаточно часто в рамках своей работы приходится сталкиваться с аналитическими системами, которые предполагают проведение тех или иных расчетов на базе готового набора данных. 
Как правило, это сложные расчеты, занимающие длительное время. Если результат не устраивает, приходится редактировать исходный набор данных, снова и снова, при этом без уверенности что внесенная правка гарантирует нужный результат.
Конечно же, можно просто отменить все правки, но иногда их может быть очень много, да и сам по себе процесс отката может быть сложным если делать его логически (а не физически, скажем из бэкапа).
В связи с этим в наших локальных системах используется подход "слепков" данных. По сути это такие же бэкапы, которые однако хранятся в таблицах, как живые данные и к которым можно вернуться в любой момент времени.
Например, пусть у нас есть некий базовый справочник:
```
CREATE TABLE someTable(id SERIAL PRIMARY KEY, someName VARCHAR(255), someParameter NUMERIC(10, 3));
```
Для того чтобы организовать хранение слепков, мы добавляем в него поле с id слепка, указывающим на справочник слепков данных:
```
CREATE TABLE someTable(id SERIAL PRIMARY KEY, scenarioId int REFERENCES scenarios, someName VARCHAR(255), someParameter NUMERIC(10, 3));
```
где *scenarios* - это специальная таблица, содержащая информацию о всех существующих в данный момент слепках данных.
Естественно что пользователь при начале работы с системой выбирает, с каким слепком он будет работать в данный момент. Когда редактируется выбранный слепок, другие никак не меняются.
Еще один важный здесь момент - это существование т.н. несценарных таблиц, т.е. таблиц которые являются общими для всех слепков. Как правило это сама таблица слепков и еще ряд таблиц которые по сути являются константами - например справочник регионов РФ, и т.п.
На данный момент наши системы ориентированы на работу с СУБД MS SQL Server. Однако в связи со сложившейся ситуацией и невозможностью в адекватные сроки и затраты расширять парк инсталляций данной СУБД, возникает потребность реализовать хранилище слепков на СУБД Postgre SQL.
Хранилище должно реализовывать следующие функциональные требования:
1) Предоставлять данные о всех имеющихся слепках (названия и другая метаинформация необходимая для навигации по ним).
2) Создание новых слепков для заполнения (т.е. изначально пустых).
3) Использование существующего слепка для создания нового (т.е. новый слепок будет содержать данные, скопированные из выбранного другого).
4) Удаление уже ненужных слепков (т.к. они могут занимать много места).
5) Создание списков сценарных таблиц должно быть автоматическим, т.к. иначе могли бы потребоваться программные модификации при изменении списка справочников, что не совсем удобно, т.к. справочники могут быть настраиваемыми.
6) Исключение несценарных таблиц из списка рабочих.

## Архитектура решения
В результате анализа требований, стало ясно, что в будущей БД потребуется создать следующие служебные объекты:
1) Таблица слепков (для п.1 требований)
2) Процедура создания слепка (п.2, п.3, п.5 требований)
3) Процедура удаления слепка (п.4 требований)
4) Таблица со списком несценарных таблиц (п.6 требований)
Остальные объекты будем создавать уже как тестовое наполнение системы.
